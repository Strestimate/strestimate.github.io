<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <title>PBL-alpha</title>

    <!-- Load TensorFlow.js union bundle from a script tag -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <!-- Load MediaPipe face detection bundle from a script tag -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>

    <!-- Load the face extractor -->
    <script src="./faceExtract.js"></script>
    <!-- Load the stress detector -->
    <script src="./stressDetect.js"></script>
    <!-- Load the model file -->
    <script src="./TFmodel.js"></script>
    <!-- Load index.css -->
    <link rel="stylesheet" href="index.css">
</head>

<body onload="loadDetector()">

    <div align="center">
        <h1>Stress Detection via Facial Imaging</h1>
        <h4>--- Test deployment in TensorflowJS ---</h4>
        <hr><br>

        <video id="video" height="240" autoplay></video><br>
        <label for="capture">Take a photo:</label>
        <button id="capture">Capture</button>
        <canvas id="canvasCapture" hidden></canvas>


        <label for="inImage">or upload an image:</label>
        <input type="file" id="inImage" accept="image/*" onchange="loadFile(event)">

        <h3>Current test image taken:</h3>
        <img hidden id="testImage" crossorigin="anonymous"></img>
        <img id="displayImage" width="200" height="240"></img>

        <h4>Detected Stress Value: <span id="resultValue"></span></h4><br>
        <h6>view console for logs</h6>
        <hr>
        <h5>---Detected Faces---</h5>

    </div>

    <script type="text/javascript">
        let detector;
        let testImage = document.getElementById("testImage");
        let modelReady = false;

        // Getting the webcam stream
        const video = document.getElementById('video');
        const canvasCapture = document.getElementById('canvasCapture');
        const capture = document.getElementById('capture');

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                    video.play();
                });
        }

        //function to load the model on page load
        async function loadDetector() {
            detector = await loadModel();
            modelReady = true;
        }

        //detection from image upload
        let loadFile = function (event) {
            testImage.src = URL.createObjectURL(event.target.files[0]);
            runTest();
        };

        //detection from captured image
        capture.addEventListener('click', function () {
            canvasCapture.getContext('2d').drawImage(video, 0, 0, canvasCapture.width, canvasCapture.height);
            const dataURL = canvasCapture.toDataURL('image/png');// Converting the canvas to a data URL
            testImage.src = dataURL;
            runTest();
        });

        //function to run the detector
        async function runTest() {
            testImage.onload = async function () {
                if (modelReady) {
                    let displayImage = document.getElementById("displayImage");
                    displayImage.src = testImage.src;

                    const result = await detector.getStress(testImage);//running the test

                    const face=await detector.getFace(testImage);
                    document.body.appendChild(face);//appending the detected face (just for debugging)

                    document.getElementById("resultValue").innerHTML = result;
                }
            }
        }

    </script>
</body>

</html>